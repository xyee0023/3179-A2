<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radar Chart with Country Filter Dropdown</title>
    <!-- Load Vega Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #radar-chart {
            margin: 0px 0px 0px 0px;
            width: 600px;
            height: 600px;
        }
        .filter-container {
            display: flex;
            gap: 50px; /* Adjusts space between the filters */
            margin: 0px 10px 10px 5px;
        }
        .filter {
            width: 150px;
        }
        #legend {
            margin: 10px 0px 0px 0px;
            padding: 10px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            width: fit-content;
            font-size: 16px;
        }
    </style>
    </head>
    <body>    
        <!-- Dropdown filters for selecting countries -->
        <div class="filter-container">
            <div class="filter">
                <label for="country1">Select Country 1: </label>
                <select id="country1">
                    <!-- Options will be dynamically populated here -->
                </select>
            </div>
    
            <div class="filter">
                <label for="country2">Select Country 2: </label>
                <select id="country2">
                    <!-- Options will be dynamically populated here -->
                </select>
            </div>
        </div>
    
        <!-- Dynamic Color Legend -->
        <div id="legend">Color Legend: </div>
    
        <!-- Div where the radar chart will be rendered -->
        <div id="radar-chart"></div>

    <!-- Vega Script -->
    <script>
        // Define a fixed color mapping for each country
        const countryColorMapping = {
            "United States of America": "#1f77b4", "China": "#ff7f0e", "United Kingdom": "#2ca02c",
            "Canada": "#d62728", "Israel": "#9467bd", "Singapore": "#8c564b", "South Korea": "#e377c2",
            "The Netherlands": "#7f7f7f", "Germany": "#bcbd22", "France": "#17becf", "Australia": "#393b79",
            "Ireland": "#637939", "Finland": "#8c6d31", "Denmark": "#843c39", "Luxembourg": "#7b4173",
            "Japan": "#ce6dbd", "India": "#de9ed6", "Switzerland": "#7b7b7b", "Sweden": "#bcbd22",
            "Hong Kong": "#d6616b", "Spain": "#e7969c", "Austria": "#e7cb94", "Estonia": "#ad494a",
            "Taiwan": "#d6616b", "Norway": "#a55194", "Saudi Arabia": "#e377c2", "Belgium": "#ff9896",
            "Poland": "#98df8a", "Slovenia": "#c7c7c7", "New Zealand": "#ff7f0e", "Italy": "#8ca252",
            "Russia": "#17becf", "Malta": "#aec7e8", "United Arab Emirates": "#2ca02c", "Portugal": "#c5b0d5",
            "Czech Republic": "#9467bd", "Iceland": "#8c6d31", "Lithuania": "#bd9e39", "Brazil": "#e7ba52",
            "Greece": "#bd9e39", "Slovakia": "#e7969c", "Hungary": "#e7cb94", "Malaysia": "#843c39",
            "Mexico": "#ad494a", "Chile": "#7b4173", "Argentina": "#d6616b", "Qatar": "#ff9896",
            "Turkey": "#17becf", "Colombia": "#bcbd22", "Uruguay": "#c49c94", "Bahrain": "#dbdb8d",
            "Vietnam": "#c7c7c7", "Indonesia": "#9edae5", "Tunisia": "#17becf", "South Africa": "#1f77b4",
            "Morocco": "#aec7e8", "Armenia": "#ff7f0e", "Sri Lanka": "#ffbb78", "Egypt": "#c49c94",
            "Kenya": "#e377c2", "Nigeria": "#f7b6d2", "Pakistan": "#bcbd22"
        };

        // Define initial radar chart specification
        var radarSpec = {
            "$schema": "https://vega.github.io/schema/vega/v5.json",
            "description": "A radar chart showing AI capabilities for selected countries.",
            "width": 500,
            "height": 500,
            "padding": 70,
            "autosize": {"type": "none", "contains": "padding"},
            "signals": [
                {"name": "radius", "update": "width / 2.1"}
            ],
            "data": [
                {
                    "name": "table",
                    "url": "AI_index_db.csv",
                    "format": {"type": "csv"},
                    "transform": [
                        {"type": "filter", "expr": "datum.Country == 'China' || datum.Country == 'United States of America'"},
                        {
                            "type": "fold",
                            "fields": [
                                "Talent", 
                                "Infrastructure", 
                                "Operating Environment", 
                                "Research", 
                                "Government Strategy", 
                                "Commercial", 
                                "Development"
                            ],
                            "as": ["key", "value"]
                        },
                        {"type": "identifier", "as": "category"}
                    ]
                },
                {
                    "name": "keys",
                    "source": "table",
                    "transform": [
                        {
                            "type": "aggregate",
                            "groupby": ["key"]
                        }
                    ]
                }
            ],
            "scales": [
                {
                    "name": "angular",
                    "type": "point",
                    "range": {"signal": "[-PI, PI]"},
                    "padding": 0.5,
                    "domain": {"data": "table", "field": "key"}
                },
                {
                    "name": "radial",
                    "type": "linear",
                    "range": {"signal": "[0, radius]"},
                    "zero": true,
                    "nice": false,
                    "domain": {"data": "table", "field": "value"},
                    "domainMin": 0
                },
                {
                    "name": "color",
                    "type": "ordinal",
                    "domain": Object.keys(countryColorMapping),
                    "range": Object.values(countryColorMapping)
                }
            ],
            "encode": {
                "enter": {
                    "x": {"signal": "radius"},
                    "y": {"signal": "radius"}
                }
            },
            "marks": [
                {
                    "type": "group",
                    "name": "categories",
                    "zindex": 1,
                    "from": {
                        "facet": {"data": "table", "name": "facet", "groupby": ["Country"]}
                    },
                    "marks": [
                        {
                            "type": "line",
                            "name": "category-line",
                            "from": {"data": "facet"},
                            "encode": {
                                "enter": {
                                    "interpolate": {"value": "linear-closed"},
                                    "x": {"signal": "scale('radial', datum.value) * cos(scale('angular', datum.key))"},
                                    "y": {"signal": "scale('radial', datum.value) * sin(scale('angular', datum.key))"},
                                    "stroke": {"scale": "color", "field": "Country"},
                                    "strokeWidth": {"value": 2},
                                    "fill": {"scale": "color", "field": "Country"},
                                    "fillOpacity": {"value": 0.1},
                                    "tooltip": {"signal": "{'Country': datum.Country, 'Category': datum.key, 'Value': datum.value}"}
                                }
                            }
                        },
                        // Add circles at each data point to ensure tooltips are triggered correctly
                        {
                            "type": "symbol",
                            "name": "category-points",
                            "from": {"data": "facet"},
                            "encode": {
                                "enter": {
                                    "x": {"signal": "scale('radial', datum.value) * cos(scale('angular', datum.key))"},
                                    "y": {"signal": "scale('radial', datum.value) * sin(scale('angular', datum.key))"},
                                    "size": {"value": 100},
                                    "fill": {"scale": "color", "field": "Country"},
                                    "fillOpacity": {"value": 1},
                                    "tooltip": {"signal": "{'Country': datum.Country, 'Category': datum.key, 'Value': datum.value}"}
                                }
                            }
                        }
                    ]
                },
                {
                    "type": "rule",
                    "name": "radial-grid",
                    "from": {"data": "keys"},
                    "zindex": 0,
                    "encode": {
                        "enter": {
                            "x": {"value": 0},
                            "y": {"value": 0},
                            "x2": {"signal": "radius * cos(scale('angular', datum.key))"},
                            "y2": {"signal": "radius * sin(scale('angular', datum.key))"},
                            "stroke": {"value": "lightgray"},
                            "strokeWidth": {"value": 1}
                        }
                    }
                },
                {
                    "type": "text",
                    "name": "key-label",
                    "from": {"data": "keys"},
                    "zindex": 1,
                    "encode": {
                        "enter": {
                            "x": {"signal": "(radius + 20) * cos(scale('angular', datum.key))"},
                            "y": {"signal": "(radius + 20) * sin(scale('angular', datum.key))"},
                            "text": {"field": "key"},
                            "align": [
                                {
                                    "test": "abs(scale('angular', datum.key)) > PI / 2",
                                    "value": "right"
                                },
                                {
                                    "value": "left"
                                }
                            ],
                            "baseline": [
                                {
                                    "test": "scale('angular', datum.key) > 0", "value": "top"
                                },
                                {
                                    "test": "scale('angular', datum.key) == 0", "value": "middle"
                                },
                                {
                                    "value": "bottom"
                                }
                            ],
                            "fill": {"value": "black"},
                            "fontWeight": {"value": "bold"}
                        }
                    }
                }
            ]
        };

        // Function to render the radar chart for the initially selected countries
        vegaEmbed('#radar-chart', radarSpec).then(function(result) {
            window.radarView = result.view;
            updateLegend(["China", "United States of America"]);
        }).catch(console.error);

        // Function to update the radar chart based on selected countries
        function applyFilter() {
            var selectedCountry1 = document.getElementById("country1").value;
            var selectedCountry2 = document.getElementById("country2").value;

            // Update the radarSpec's filter to include only the selected countries
            radarSpec.data[0].transform[0] = {
                "type": "filter",
                "expr": "datum.Country == '" + selectedCountry1 + "' || datum.Country == '" + selectedCountry2 + "'"
            };

            // Re-render the radar chart with the updated specification
            vegaEmbed('#radar-chart', radarSpec).then(function(result) {
                window.radarView = result.view;
                updateLegend([selectedCountry1, selectedCountry2]);
            }).catch(console.error);
        }

        // Populate the dropdowns dynamically from the CSV data
        vega.loader().load('AI_index_db.csv').then(function(data) {
            const csv = d3.csvParse(data);
            const uniqueCountries = Array.from(new Set(csv.map(d => d['Country'])));
            var country1Dropdown = document.getElementById('country1');
            var country2Dropdown = document.getElementById('country2');

            // Add each country as an option in the dropdowns
            uniqueCountries.forEach(country => {
                var option1 = document.createElement("option");
                option1.value = country;
                option1.text = country;
                country1Dropdown.appendChild(option1);

                var option2 = document.createElement("option");
                option2.value = country;
                option2.text = country;
                country2Dropdown.appendChild(option2);
            });

            // Set default values
            country1Dropdown.value = 'China';
            country2Dropdown.value = 'United States of America';

            // Add event listeners for dropdown changes
            country1Dropdown.addEventListener('change', applyFilter);
            country2Dropdown.addEventListener('change', applyFilter);
        }).catch(console.error);

        // Function to update the dynamic legend with the selected countries
        function updateLegend(selectedCountries) {
            var legendDiv = document.getElementById("legend");
            legendDiv.innerHTML = "Color Legend: ";
            selectedCountries.forEach(country => {
                var countryLabel = document.createElement("div");
                countryLabel.style.display = "inline-block";
                countryLabel.style.marginRight = "15px";
                countryLabel.style.color = countryColorMapping[country];
                countryLabel.innerHTML = `&#9679; ${country}`;
                legendDiv.appendChild(countryLabel);
            });
        }
    </script>
</body>
</html>
